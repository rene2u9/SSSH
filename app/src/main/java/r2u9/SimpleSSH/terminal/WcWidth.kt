package r2u9.SimpleSSH.terminal

/**
 * Implementation of wcwidth() based on Unicode 15.0.0.
 * Determines the display width of Unicode characters for terminal rendering.
 *
 * Characters are classified as:
 * - Width 0: Combining characters, zero-width characters
 * - Width 1: Most characters including ASCII
 * - Width 2: Wide characters (CJK, emoji, etc.)
 * - Width -1: Non-printable control characters
 *
 * Based on Termux's implementation which references:
 * - https://www.unicode.org/Public/15.0.0/ucd/EastAsianWidth.txt
 * - https://www.cl.cam.ac.uk/~mgk25/ucs/wcwidth.c
 */
object WcWidth {

    // Combining characters table - these have width 0
    private val COMBINING = intArrayOf(
        0x0300, 0x036F,   // Combining Diacritical Marks
        0x0483, 0x0489,   // Combining Cyrillic
        0x0591, 0x05BD,   // Hebrew
        0x05BF, 0x05BF,
        0x05C1, 0x05C2,
        0x05C4, 0x05C5,
        0x05C7, 0x05C7,
        0x0610, 0x061A,   // Arabic
        0x064B, 0x065F,
        0x0670, 0x0670,
        0x06D6, 0x06DC,
        0x06DF, 0x06E4,
        0x06E7, 0x06E8,
        0x06EA, 0x06ED,
        0x0711, 0x0711,   // Syriac
        0x0730, 0x074A,
        0x07A6, 0x07B0,   // Thaana
        0x07EB, 0x07F3,   // NKo
        0x07FD, 0x07FD,
        0x0816, 0x0819,   // Samaritan
        0x081B, 0x0823,
        0x0825, 0x0827,
        0x0829, 0x082D,
        0x0859, 0x085B,   // Mandaic
        0x0898, 0x089F,   // Arabic Extended-B
        0x08CA, 0x08E1,   // Arabic Extended-A
        0x08E3, 0x0903,
        0x093A, 0x093C,   // Devanagari
        0x093E, 0x094F,
        0x0951, 0x0957,
        0x0962, 0x0963,
        0x0981, 0x0983,   // Bengali
        0x09BC, 0x09BC,
        0x09BE, 0x09C4,
        0x09C7, 0x09C8,
        0x09CB, 0x09CD,
        0x09D7, 0x09D7,
        0x09E2, 0x09E3,
        0x09FE, 0x09FE,
        0x0A01, 0x0A03,   // Gurmukhi
        0x0A3C, 0x0A3C,
        0x0A3E, 0x0A42,
        0x0A47, 0x0A48,
        0x0A4B, 0x0A4D,
        0x0A51, 0x0A51,
        0x0A70, 0x0A71,
        0x0A75, 0x0A75,
        0x0A81, 0x0A83,   // Gujarati
        0x0ABC, 0x0ABC,
        0x0ABE, 0x0AC5,
        0x0AC7, 0x0AC9,
        0x0ACB, 0x0ACD,
        0x0AE2, 0x0AE3,
        0x0AFA, 0x0AFF,
        0x0B01, 0x0B03,   // Oriya
        0x0B3C, 0x0B3C,
        0x0B3E, 0x0B44,
        0x0B47, 0x0B48,
        0x0B4B, 0x0B4D,
        0x0B55, 0x0B57,
        0x0B62, 0x0B63,
        0x0B82, 0x0B82,   // Tamil
        0x0BBE, 0x0BC2,
        0x0BC6, 0x0BC8,
        0x0BCA, 0x0BCD,
        0x0BD7, 0x0BD7,
        0x0C00, 0x0C04,   // Telugu
        0x0C3C, 0x0C3C,
        0x0C3E, 0x0C44,
        0x0C46, 0x0C48,
        0x0C4A, 0x0C4D,
        0x0C55, 0x0C56,
        0x0C62, 0x0C63,
        0x0C81, 0x0C83,   // Kannada
        0x0CBC, 0x0CBC,
        0x0CBE, 0x0CC4,
        0x0CC6, 0x0CC8,
        0x0CCA, 0x0CCD,
        0x0CD5, 0x0CD6,
        0x0CE2, 0x0CE3,
        0x0D00, 0x0D03,   // Malayalam
        0x0D3B, 0x0D3C,
        0x0D3E, 0x0D44,
        0x0D46, 0x0D48,
        0x0D4A, 0x0D4D,
        0x0D57, 0x0D57,
        0x0D62, 0x0D63,
        0x0D81, 0x0D83,   // Sinhala
        0x0DCA, 0x0DCA,
        0x0DCF, 0x0DD4,
        0x0DD6, 0x0DD6,
        0x0DD8, 0x0DDF,
        0x0DF2, 0x0DF3,
        0x0E31, 0x0E31,   // Thai
        0x0E34, 0x0E3A,
        0x0E47, 0x0E4E,
        0x0EB1, 0x0EB1,   // Lao
        0x0EB4, 0x0EBC,
        0x0EC8, 0x0ECD,
        0x0F18, 0x0F19,   // Tibetan
        0x0F35, 0x0F35,
        0x0F37, 0x0F37,
        0x0F39, 0x0F39,
        0x0F3E, 0x0F3F,
        0x0F71, 0x0F84,
        0x0F86, 0x0F87,
        0x0F8D, 0x0F97,
        0x0F99, 0x0FBC,
        0x0FC6, 0x0FC6,
        0x102B, 0x103E,   // Myanmar
        0x1056, 0x1059,
        0x105E, 0x1060,
        0x1062, 0x1064,
        0x1067, 0x106D,
        0x1071, 0x1074,
        0x1082, 0x108D,
        0x108F, 0x108F,
        0x109A, 0x109D,
        0x135D, 0x135F,   // Ethiopic
        0x1712, 0x1715,   // Tagalog
        0x1732, 0x1734,   // Hanunoo
        0x1752, 0x1753,   // Buhid
        0x1772, 0x1773,   // Tagbanwa
        0x17B4, 0x17D3,   // Khmer
        0x17DD, 0x17DD,
        0x180B, 0x180D,   // Mongolian
        0x180F, 0x180F,
        0x1885, 0x1886,
        0x18A9, 0x18A9,
        0x1920, 0x192B,   // Limbu
        0x1930, 0x193B,
        0x1A17, 0x1A1B,   // Buginese
        0x1A55, 0x1A5E,   // Tai Tham
        0x1A60, 0x1A7C,
        0x1A7F, 0x1A7F,
        0x1AB0, 0x1ACE,   // Combining Diacritical Marks Extended
        0x1B00, 0x1B04,   // Balinese
        0x1B34, 0x1B44,
        0x1B6B, 0x1B73,
        0x1B80, 0x1B82,   // Sundanese
        0x1BA1, 0x1BAD,
        0x1BE6, 0x1BF3,   // Batak
        0x1C24, 0x1C37,   // Lepcha
        0x1CD0, 0x1CD2,   // Vedic Extensions
        0x1CD4, 0x1CE8,
        0x1CED, 0x1CED,
        0x1CF4, 0x1CF4,
        0x1CF7, 0x1CF9,
        0x1DC0, 0x1DFF,   // Combining Diacritical Marks Supplement
        0x20D0, 0x20F0,   // Combining Diacritical Marks for Symbols
        0x2CEF, 0x2CF1,   // Coptic
        0x2D7F, 0x2D7F,   // Tifinagh
        0x2DE0, 0x2DFF,   // Cyrillic Extended-A
        0x302A, 0x302F,   // CJK Symbols and Punctuation
        0x3099, 0x309A,   // Hiragana
        0xA66F, 0xA672,   // Combining Cyrillic
        0xA674, 0xA67D,
        0xA69E, 0xA69F,
        0xA6F0, 0xA6F1,   // Bamum
        0xA802, 0xA802,   // Syloti Nagri
        0xA806, 0xA806,
        0xA80B, 0xA80B,
        0xA823, 0xA827,
        0xA82C, 0xA82C,
        0xA880, 0xA881,   // Saurashtra
        0xA8B4, 0xA8C5,
        0xA8E0, 0xA8F1,   // Devanagari Extended
        0xA8FF, 0xA8FF,
        0xA926, 0xA92D,   // Kayah Li
        0xA947, 0xA953,   // Rejang
        0xA980, 0xA983,   // Javanese
        0xA9B3, 0xA9C0,
        0xA9E5, 0xA9E5,   // Myanmar Extended-B
        0xAA29, 0xAA36,   // Cham
        0xAA43, 0xAA43,
        0xAA4C, 0xAA4D,
        0xAA7B, 0xAA7D,
        0xAAB0, 0xAAB0,   // Tai Viet
        0xAAB2, 0xAAB4,
        0xAAB7, 0xAAB8,
        0xAABE, 0xAABF,
        0xAAC1, 0xAAC1,
        0xAAEB, 0xAAEF,   // Meetei Mayek Extensions
        0xAAF5, 0xAAF6,
        0xABE3, 0xABEA,   // Meetei Mayek
        0xABEC, 0xABED,
        0xFB1E, 0xFB1E,   // Hebrew
        0xFE00, 0xFE0F,   // Variation Selectors
        0xFE20, 0xFE2F,   // Combining Half Marks
        0x101FD, 0x101FD, // Phaistos Disc
        0x102E0, 0x102E0, // Coptic
        0x10376, 0x1037A, // Old Permic
        0x10A01, 0x10A03, // Kharoshthi
        0x10A05, 0x10A06,
        0x10A0C, 0x10A0F,
        0x10A38, 0x10A3A,
        0x10A3F, 0x10A3F,
        0x10AE5, 0x10AE6, // Manichaean
        0x10D24, 0x10D27, // Hanifi Rohingya
        0x10EAB, 0x10EAC, // Yezidi
        0x10F46, 0x10F50, // Sogdian
        0x10F82, 0x10F85, // Old Uyghur
        0x11000, 0x11002, // Brahmi
        0x11038, 0x11046,
        0x11070, 0x11070,
        0x11073, 0x11074,
        0x1107F, 0x11082, // Kaithi
        0x110B0, 0x110BA,
        0x110C2, 0x110C2,
        0x11100, 0x11102, // Chakma
        0x11127, 0x11134,
        0x11145, 0x11146,
        0x11180, 0x11182, // Sharada
        0x111B3, 0x111C0,
        0x111C9, 0x111CC,
        0x111CE, 0x111CF,
        0x1122C, 0x11237, // Khojki
        0x1123E, 0x1123E,
        0x112DF, 0x112EA, // Khudawadi
        0x11300, 0x11303, // Grantha
        0x1133B, 0x1133C,
        0x1133E, 0x11344,
        0x11347, 0x11348,
        0x1134B, 0x1134D,
        0x11357, 0x11357,
        0x11362, 0x11363,
        0x11366, 0x1136C,
        0x11370, 0x11374,
        0x11435, 0x11446, // Newa
        0x1145E, 0x1145E,
        0x114B0, 0x114C3, // Tirhuta
        0x115AF, 0x115B5, // Siddham
        0x115B8, 0x115C0,
        0x115DC, 0x115DD,
        0x11630, 0x11640, // Modi
        0x116AB, 0x116B7, // Takri
        0x1171D, 0x1172B, // Ahom
        0x1182C, 0x1183A, // Dogra
        0x11930, 0x11935, // Dives Akuru
        0x11937, 0x11938,
        0x1193B, 0x1193E,
        0x11940, 0x11940,
        0x11942, 0x11943,
        0x119D1, 0x119D7, // Nandinagari
        0x119DA, 0x119E0,
        0x119E4, 0x119E4,
        0x11A01, 0x11A0A, // Zanabazar Square
        0x11A33, 0x11A39,
        0x11A3B, 0x11A3E,
        0x11A47, 0x11A47,
        0x11A51, 0x11A5B, // Soyombo
        0x11A8A, 0x11A99,
        0x11C2F, 0x11C36, // Bhaiksuki
        0x11C38, 0x11C3F,
        0x11C92, 0x11CA7, // Marchen
        0x11CA9, 0x11CB6,
        0x11D31, 0x11D36, // Masaram Gondi
        0x11D3A, 0x11D3A,
        0x11D3C, 0x11D3D,
        0x11D3F, 0x11D45,
        0x11D47, 0x11D47,
        0x11D8A, 0x11D8E, // Gunjala Gondi
        0x11D90, 0x11D91,
        0x11D93, 0x11D97,
        0x11EF3, 0x11EF6, // Makasar
        0x16AF0, 0x16AF4, // Bassa Vah
        0x16B30, 0x16B36, // Pahawh Hmong
        0x16F4F, 0x16F4F, // Miao
        0x16F51, 0x16F87,
        0x16F8F, 0x16F92,
        0x16FE4, 0x16FE4, // Khitan Small Script
        0x1BC9D, 0x1BC9E, // Duployan
        0x1CF00, 0x1CF2D, // Znamenny
        0x1CF30, 0x1CF46,
        0x1D165, 0x1D169, // Musical Symbols
        0x1D16D, 0x1D172,
        0x1D17B, 0x1D182,
        0x1D185, 0x1D18B,
        0x1D1AA, 0x1D1AD,
        0x1D242, 0x1D244, // Combining Greek Musical Symbols
        0x1DA00, 0x1DA36, // Sutton SignWriting
        0x1DA3B, 0x1DA6C,
        0x1DA75, 0x1DA75,
        0x1DA84, 0x1DA84,
        0x1DA9B, 0x1DA9F,
        0x1DAA1, 0x1DAAF,
        0x1E000, 0x1E006, // Glagolitic Supplement
        0x1E008, 0x1E018,
        0x1E01B, 0x1E021,
        0x1E023, 0x1E024,
        0x1E026, 0x1E02A,
        0x1E130, 0x1E136, // Nyiakeng Puachue Hmong
        0x1E2AE, 0x1E2AE, // Toto
        0x1E2EC, 0x1E2EF, // Wancho
        0x1E8D0, 0x1E8D6, // Mende Kikakui
        0x1E944, 0x1E94A, // Adlam
        0xE0100, 0xE01EF  // Variation Selectors Supplement
    )

    // Wide characters table - these have width 2
    private val WIDE = intArrayOf(
        0x1100, 0x115F,   // Hangul Jamo
        0x231A, 0x231B,   // Watch, Hourglass
        0x2329, 0x232A,   // Angle brackets
        0x23E9, 0x23F3,   // Media control symbols
        0x23F8, 0x23FA,
        0x25FD, 0x25FE,   // Squares
        0x2614, 0x2615,   // Umbrella, Hot Beverage
        0x2648, 0x2653,   // Zodiac
        0x267F, 0x267F,   // Wheelchair
        0x2693, 0x2693,   // Anchor
        0x26A1, 0x26A1,   // High Voltage
        0x26AA, 0x26AB,   // Circles
        0x26BD, 0x26BE,   // Soccer, Baseball
        0x26C4, 0x26C5,   // Snowman, Sun Behind Cloud
        0x26CE, 0x26CE,   // Ophiuchus
        0x26D4, 0x26D4,   // No Entry
        0x26EA, 0x26EA,   // Church
        0x26F2, 0x26F3,   // Fountain, Golf
        0x26F5, 0x26F5,   // Sailboat
        0x26FA, 0x26FA,   // Tent
        0x26FD, 0x26FD,   // Fuel Pump
        0x2702, 0x2702,   // Scissors
        0x2705, 0x2705,   // Check Mark
        0x2708, 0x270D,   // Airplane to Writing Hand
        0x270F, 0x270F,   // Pencil
        0x2712, 0x2712,   // Black Nib
        0x2714, 0x2714,   // Check Mark
        0x2716, 0x2716,   // X Mark
        0x271D, 0x271D,   // Latin Cross
        0x2721, 0x2721,   // Star of David
        0x2728, 0x2728,   // Sparkles
        0x2733, 0x2734,   // Eight Spoked Asterisk
        0x2744, 0x2744,   // Snowflake
        0x2747, 0x2747,   // Sparkle
        0x274C, 0x274C,   // Cross Mark
        0x274E, 0x274E,   // Cross Mark
        0x2753, 0x2755,   // Question Marks
        0x2757, 0x2757,   // Exclamation Mark
        0x2763, 0x2764,   // Heart Exclamation, Heart
        0x2795, 0x2797,   // Plus, Minus, Division
        0x27A1, 0x27A1,   // Right Arrow
        0x27B0, 0x27B0,   // Curly Loop
        0x27BF, 0x27BF,   // Double Curly Loop
        0x2934, 0x2935,   // Arrows
        0x2B05, 0x2B07,   // Arrows
        0x2B1B, 0x2B1C,   // Squares
        0x2B50, 0x2B50,   // Star
        0x2B55, 0x2B55,   // Circle
        0x3000, 0x3000,   // Ideographic Space
        0x3004, 0x3004,   // Japanese Industrial Standard Symbol
        0x3008, 0x3008,   // Left Angle Bracket
        0x3009, 0x3009,   // Right Angle Bracket
        0x300A, 0x300B,   // Double Angle Brackets
        0x300C, 0x300D,   // Corner Brackets
        0x300E, 0x300F,   // White Corner Brackets
        0x3010, 0x3011,   // Black Lenticular Brackets
        0x3014, 0x3017,   // Tortoise Shell Brackets
        0x3018, 0x301B,   // White Brackets
        0x301C, 0x301C,   // Wave Dash
        0x301D, 0x301F,   // Quotation Marks
        0x3030, 0x3030,   // Wavy Dash
        0x303E, 0x303E,   // Ideographic Variation Indicator
        0x3041, 0x3096,   // Hiragana
        0x309B, 0x30FF,   // Katakana
        0x3105, 0x312F,   // Bopomofo
        0x3131, 0x318E,   // Hangul Compatibility Jamo
        0x3190, 0x31E3,   // Kanbun to CJK Strokes
        0x31F0, 0x321E,   // Katakana Extension to Enclosed CJK
        0x3220, 0x3247,   // Enclosed CJK
        0x3250, 0x4DBF,   // CJK
        0x4E00, 0x9FFF,   // CJK Unified Ideographs
        0xA000, 0xA48C,   // Yi Syllables
        0xA490, 0xA4C6,   // Yi Radicals
        0xA960, 0xA97F,   // Hangul Jamo Extended-A
        0xAC00, 0xD7A3,   // Hangul Syllables
        0xF900, 0xFAFF,   // CJK Compatibility Ideographs
        0xFE10, 0xFE19,   // Vertical Forms
        0xFE30, 0xFE52,   // CJK Compatibility Forms
        0xFE54, 0xFE66,
        0xFE68, 0xFE6B,
        0xFF01, 0xFF60,   // Fullwidth Forms
        0xFFE0, 0xFFE6,
        0x16FE0, 0x16FE4, // Ideographic Symbols
        0x16FF0, 0x16FF1,
        0x17000, 0x187F7, // Tangut
        0x18800, 0x18CD5,
        0x18D00, 0x18D08,
        0x1AFF0, 0x1AFF3, // Kana Extended-B
        0x1AFF5, 0x1AFFB,
        0x1AFFD, 0x1AFFE,
        0x1B000, 0x1B122, // Kana Supplement
        0x1B150, 0x1B152, // Small Kana Extension
        0x1B164, 0x1B167,
        0x1B170, 0x1B2FB, // Nushu
        0x1F004, 0x1F004, // Mahjong Tile
        0x1F0CF, 0x1F0CF, // Playing Card
        0x1F18E, 0x1F18E, // Negative Squared AB
        0x1F191, 0x1F19A, // Squared CL to VS
        0x1F200, 0x1F202, // Enclosed Ideographic Supplement
        0x1F210, 0x1F23B,
        0x1F240, 0x1F248,
        0x1F250, 0x1F251,
        0x1F260, 0x1F265,
        0x1F300, 0x1F320, // Miscellaneous Symbols and Pictographs
        0x1F32D, 0x1F335,
        0x1F337, 0x1F37C,
        0x1F37E, 0x1F393,
        0x1F3A0, 0x1F3CA,
        0x1F3CF, 0x1F3D3,
        0x1F3E0, 0x1F3F0,
        0x1F3F4, 0x1F3F4,
        0x1F3F8, 0x1F43E,
        0x1F440, 0x1F440,
        0x1F442, 0x1F4FC,
        0x1F4FF, 0x1F53D,
        0x1F54B, 0x1F54E,
        0x1F550, 0x1F567,
        0x1F57A, 0x1F57A,
        0x1F595, 0x1F596,
        0x1F5A4, 0x1F5A4,
        0x1F5FB, 0x1F64F,
        0x1F680, 0x1F6C5,
        0x1F6CC, 0x1F6CC,
        0x1F6D0, 0x1F6D2,
        0x1F6D5, 0x1F6D7,
        0x1F6DD, 0x1F6DF,
        0x1F6EB, 0x1F6EC,
        0x1F6F4, 0x1F6FC,
        0x1F7E0, 0x1F7EB,
        0x1F7F0, 0x1F7F0,
        0x1F90C, 0x1F93A,
        0x1F93C, 0x1F945,
        0x1F947, 0x1F9FF,
        0x1FA00, 0x1FA53,
        0x1FA60, 0x1FA6D,
        0x1FA70, 0x1FA74,
        0x1FA78, 0x1FA7C,
        0x1FA80, 0x1FA86,
        0x1FA90, 0x1FAAC,
        0x1FAB0, 0x1FABA,
        0x1FAC0, 0x1FAC5,
        0x1FAD0, 0x1FAD9,
        0x1FAE0, 0x1FAE7,
        0x1FAF0, 0x1FAF6,
        0x20000, 0x2FFFD, // CJK Extension B-F
        0x30000, 0x3FFFD
    )

    private fun bisearch(ucs: Int, table: IntArray): Boolean {
        if (ucs < table[0] || ucs > table[table.size - 1]) return false
        var min = 0
        var max = table.size / 2 - 1
        while (max >= min) {
            val mid = (min + max) / 2
            if (ucs > table[2 * mid + 1]) {
                min = mid + 1
            } else if (ucs < table[2 * mid]) {
                max = mid - 1
            } else {
                return true
            }
        }
        return false
    }

    /**
     * Returns the display width of a Unicode code point.
     * @param codePoint The Unicode code point to measure
     * @return -1 for non-printable, 0 for combining, 1 for normal, 2 for wide characters
     */
    fun width(codePoint: Int): Int {
        // Null character
        if (codePoint == 0) return 0

        // C0/C1 control characters
        if (codePoint < 32 || (codePoint in 0x7F..0x9F)) return -1

        // Combining characters have width 0
        if (bisearch(codePoint, COMBINING)) return 0

        // Wide characters have width 2
        if (bisearch(codePoint, WIDE)) return 2

        // Default to width 1
        return 1
    }

    /**
     * Returns the display width of a character.
     */
    fun width(c: Char): Int = width(c.code)

    /**
     * Returns the display width of a character in a char array, handling surrogates.
     * @param chars The character array
     * @param index The index of the character
     * @return The width of the character at the given index
     */
    fun width(chars: CharArray, index: Int): Int {
        val c = chars[index]
        return if (Character.isHighSurrogate(c) && index + 1 < chars.size) {
            val low = chars[index + 1]
            if (Character.isLowSurrogate(low)) {
                width(Character.toCodePoint(c, low))
            } else {
                width(c.code)
            }
        } else {
            width(c.code)
        }
    }

    /**
     * Calculate the display width of a string.
     */
    fun width(text: String): Int {
        var width = 0
        var i = 0
        while (i < text.length) {
            val codePoint = text.codePointAt(i)
            val w = width(codePoint)
            if (w > 0) width += w
            i += Character.charCount(codePoint)
        }
        return width
    }
}
